{"version":3,"sources":["app.es6"],"names":[],"mappings":"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","file":"app.js","sourcesContent":["var express = require('express');\nvar path = require('path');\nvar favicon = require('serve-favicon');\n// require('babel-polyfill');\nvar app = express();\n\n// view engine setup\napp.set('views', path.join(__dirname, \"../../client\"));\napp.engine('html', require('ejs').renderFile);\napp.set('view engine', 'html');\n\n//static folder\napp.use(express.static(path.join(__dirname, 'public')));\napp.use(\"/\", express.static(path.join(__dirname, \"../../client\")));\n\n//log\nvar logger = require('morgan');\napp.use(logger('dev'));\n\n//body parser\nlet bodyParser = require('body-parser');\napp.use(bodyParser.urlencoded({extended: false}));\napp.use(bodyParser.json({type:\"application/json\"}));\n\n\n//cookie and session\nvar cookieParser = require('cookie-parser');\nvar cookieSession = require('cookie-session');\napp.use(cookieParser());\napp.use(cookieSession({\n    keys: [\"username\", \"password\"]\n}));\napp.use((req, res, next)=> {\n    req.cookieSession = cookieSession;\n    next();\n});\n\n//extend\nrequire(\"karl-extend\");\n\n\nlet session = require(\"./session\");\napp.use(session);\n\n//route\nlet route = require(\"./route\");\napp.use(\"/\", route);\n\n//upload dir\nlet fs = require(\"fs\");\nif(!fs.existsSync(\"./server/upload/\")){\n    fs.mkdirSync(\"./server/upload/\");\n}\n//client data\nif(!fs.existsSync(\"./client/data/\")){\n    fs.mkdirSync(\"./client/data/\");\n}\n\n//global config\nlet xml = require(\"../../util/xml\");\nlet promise1 = xml.read(\"./server/config/account.xml\");\nlet promise2 = xml.read(\"./server/config/mysql.xml\");\nPromise.all([promise1, promise2]).then(d=> {\n    global.accountConfig = {\n        username: d[0].root.username[0],\n        password: d[0].root.password[0],\n        usernameCookie: d[0].root.usernameCookie[0],\n        passwordCookie: d[0].root.passwordCookie[0],\n        loginRedirect: d[0].root.loginRedirect[0]\n    };\n\n\n    let mysql = require(\"../../util/mysql\");\n    mysql.init(\"localhost\", d[1].root.user[0], d[1].root.password[0], d[1].root.database[0]);\n    console.log(\"mysql init success\");\n\n    mysql.excuteQuery(\"show tables\", {}).then(function (d) {\n        let tableNames = d.map(d1=> {\n            let tableName;\n            for (let k in d1) {\n                tableName = d1[k];\n                break;\n            }\n            return tableName;\n        });\n        let descTablePromise = [];\n        tableNames.map(d1=> {\n            descTablePromise.push(mysql.excuteQuery(\"desc \" + d1));\n        });\n        global.dbStruct = [];\n        Promise.all(descTablePromise).then(d1=> {\n            for (let i = 0; i < d1.length; i++) {\n                let tableName = tableNames[i];\n                let tableDesc = d1[i];\n                global.dbStruct.push({id: tableName, fields: tableDesc});\n            }\n            console.log(\"get database structure successfully\");\n        }).catch(d1=> {\n            console.log(\"get table structure failed:\")\n            console.log(d1);\n        });\n    }).catch(function (d) {\n        console.log(\"get database structure failed:\");\n        console.log(d);\n    });\n\n}).catch(d=> {\n    console.log(d);\n});\n\n// catch 404 and forward to error handler\napp.use(function (req, res, next) {\n    var err = new Error('Not Found');\n    err.status = 404;\n    next(err);\n});\n\n// error handlers\n\n// development error handler\n// will print stacktrace\nif (app.get('env') === 'development') {\n    app.use(function (err, req, res, next) {\n        res.status(err.status || 500);\n        console.log(\"server error:\");\n        console.log(err);\n        res.render('error/');\n    });\n}\n\n// production error handler\n// no stacktraces leaked to user\napp.use(function (err, req, res, next) {\n    res.status(err.status || 500);\n    console.log(\"server error:\");\n    console.log(err);\n    res.render('error/');\n});\n\n\nmodule.exports = app;\n"]}